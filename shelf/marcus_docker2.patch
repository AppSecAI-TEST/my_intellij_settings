Index: docker-compose-tests.yml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- docker-compose-tests.yml	(revision )
+++ docker-compose-tests.yml	(revision )
@@ -0,0 +1,53 @@
+couchbase:
+  image: couchbase:community-3.0.1
+  expose:
+    - "8091"
+
+app:
+  build: .
+  environment:
+    couchbase__host: couchbase
+    security__login__cypher_secret: secret
+  links:
+    - couchbase
+
+unit:
+  build: .
+  command: unit-test:all
+  environment:
+    security__login__cypher_secret: secret
+
+client:
+  build: .
+  command: client-test
+  environment:
+    DOCKER: 1
+    RPLANX_TEST_SERVER: selenium_hub
+  external_links:
+      - selenium_hub
+
+rest:
+  build: .
+  command: rest-api-test:all
+  environment:
+    couchbase__host: couchbase
+    DOCKER: 1
+    security__login__cypher_secret: secret
+    app__host: app
+  links:
+    - app
+    - couchbase
+
+system:
+  build: .
+  command: system-test:all
+  environment:
+    couchbase__host: couchbase
+    DOCKER: 1
+    security__login__cypher_secret: secret
+    app__host: app
+    RPLANX_TEST_SERVER: selenium_hub
+  links:
+    - app
+    - couchbase
+
Index: Dockerfile
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- Dockerfile	(revision a569e8195fb4339b13d238b9a7366803227d382d)
+++ Dockerfile	(revision )
@@ -1,22 +1,38 @@
 FROM node:4.1.2
 
+WORKDIR /opt/actano/rplan
+
+# This one as long as the build-server remains from lake
 RUN apt-get update && apt-get install -y netcat-openbsd
 
-# Add Tini
-ENV TINI_VERSION v0.6.0
-ADD https://github.com/krallin/tini/releases/download/${TINI_VERSION}/tini /tini
-RUN chmod +x /tini
+ENV npm_config_cache /var/cache/npm-cache
 
-ADD package.json /opt/actano/rplan/package.json
-ADD npm-shrinkwrap.json /opt/actano/rplan/npm-shrinkwrap.json
-ADD docker.npmrc /opt/actano/rplan/.npmrc
-WORKDIR /opt/actano/rplan
+# for npm install externals
+ADD package.json npm-shrinkwrap.json ./
+
+# Install externals and run prepublish
 RUN npm install
-ADD . /opt/actano/rplan
+
+# Sources
+ADD *.md *.js *.coffee features ./
+ADD lib lib
+ADD tools tools
+
+# As long as we need make
+ADD Makefile *.mk ./
+ENV NO_WEBPACK 1
 RUN make build
 
-EXPOSE 8081
-ENTRYPOINT ["/tini", "--", "npm", "run"]
+# Build Client-Application
+RUN npm run client-build
+
+# Configuration
+ADD etc etc
+
+# Test deps
+ADD test test
+
+ENTRYPOINT ["npm", "run"]
 
 # Change to start when only docker is used
 CMD ["start_docker"]
Index: package.json
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- package.json	(revision a569e8195fb4339b13d238b9a7366803227d382d)
+++ package.json	(revision )
@@ -2,13 +2,18 @@
   "name": "actano-rplan",
   "version": "1.0.0",
   "scripts": {
-    "start":"make build; $npm_package_config_node_cli $npm_package_config_node_flags ./index.js start",
-    "start_docker": "make build; $npm_package_config_node_cli $npm_package_config_node_flags lib/webapp/webapp.js",
+    "start": "$npm_package_config_node_cli $npm_package_config_node_flags ./index.js start",
     "stop": "export PID=$(ps aux | grep -v grep | grep $npm_package_config_node_cli | grep /webapp | awk '{print $2}'); if [ \"${PID}\" ]; then kill -9 ${PID}; echo \"Stopped Process ${PID}\"; fi",
     "test": "tools/fail-fast-wrapper.sh \"npm run unit-test:all\" \"npm run client-test -- --browsers=$npm_package_config_browsers_to_test\" \"npm run rest-api-test:all\" \"npm run system-test:all -- --browsers=$npm_package_config_browsers_to_test\"",
     "postinstall": "npm_tmp_dir=$(npm config get tmp); [ -d \"$npm_tmp_dir\" ] && rm -rf \"$npm_tmp_dir\"/npm-*; touch node_modules/.install.d",
+    "prepublish": "make build",
+    "start_docker": "$npm_package_config_node_cli $npm_package_config_node_flags ./index.js --cbClusterInit --cbCreateBuckets --cbUpsertAllDesignDocuments run",
     "mocha": "mocha $npm_package_config_node_flags --compilers coffee:coffee-script/register",
     "coffee": "coffee --nodejs \"$npm_package_config_node_flags\" --",
+    "reset-db": "$npm_package_config_node_cli $npm_package_config_node_flags ./index.js prepare --cbRemoveBuckets --cbCreateBuckets --cbUpsertAllDesignDocuments --cbQueryAllViews --cbCleanImportUsers lib/testdata/user-samples/dev-default-users.coffee",
+    "clean": "npm stop && rm -rf build && rm -rf test_reports",
+    "clean-test": "npm run clean && npm run reset-db && npm start && npm test",
+    "failed-report": "npm run coffee tools/failed-reporter.coffee",
     "client-build": "webpack --colors --progress --bail",
     "client-build:watch": "webpack --colors --progress --watch",
     "unit-test": "npm run coffee -- tools/run-tests.coffee --mode unit",
@@ -16,10 +21,6 @@
     "unit-test:all": "npm run unit-test -- --pattern test/unit.coffee",
     "client-test": "TEST_REPORTS=test_reports npm run coffee -- tools/karma.coffee",
     "client-test:watch": "npm run client-test -- --debug",
-    "reset-db": "$npm_package_config_node_cli $npm_package_config_node_flags ./index.js prepare --cbRemoveBuckets --cbCreateBuckets --cbUpsertAllDesignDocuments --cbQueryAllViews --cbCleanImportUsers lib/testdata/user-samples/dev-default-users.coffee",
-    "clean": "npm stop && rm -rf build && rm -rf test_reports",
-    "clean-test": "npm run clean && npm run reset-db && npm start && npm test",
-    "failed-report": "npm run coffee tools/failed-reporter.coffee",
     "rest-api-test": "npm run coffee -- tools/run-tests.coffee --mode rest-api",
     "rest-api-test:watch": "npm run rest-api-test -- -- --watch",
     "rest-api-test:all": "npm run rest-api-test -- --pattern test/rest-api.coffee",
@@ -30,7 +31,6 @@
   },
   "config": {
     "node_cli": "node",
-    "node_flags": "--harmony-generators",
     "browsers_to_test": "chrome,firefox"
   },
   "repository": {
@@ -104,6 +104,7 @@
     "model-undoable": "git://github.com/ericgj/model-undoable",
     "moment": "^2.10.2",
     "nconf": "~0.6.7",
+    "nconf-yaml": "^1.0.1",
     "node-polyglot": "^0.3.0",
     "node-uuid": "~1.4.0",
     "nodemailer": "^0.7.1",
Index: common.yml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- common.yml	(revision a569e8195fb4339b13d238b9a7366803227d382d)
+++ common.yml	(revision )
@@ -1,5 +1,19 @@
-rplan:
-    ports:
-        - "8081:8081"
-    container_name: rplan
+nodejs:
+  build: .
+  dockerfile: Dockerfile.dev
-    env_file: .env
+  env_file: .env
+  volumes:
+    - .:/opt/actano/rplan
+    - /var/cache/rplan/node_modules:/opt/actano/rplan/node_modules
+    - /var/cache/rplan/build:/opt/actano/rplan/build
+    - /var/cache/npm-cache:/var/cache/npm-cache
+
+chrome:
+  image: selenium/node-chrome-debug:2.47.1
+  environment:
+    SCREEN_WIDTH: 1920
+    SCREEN_HEIGHT: 1080
+  ports:
+    - "5900:5900"
+  volumes:
+    - /dev/shm:/dev/shm
Index: tools/test.coffee
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- tools/test.coffee	(revision )
+++ tools/test.coffee	(revision )
@@ -0,0 +1,8 @@
+nconf = require 'nconf'
+nconf.env().file file: 'conf.yml', format: require 'nconf-yaml'
+nconf.load (err) ->
+    console.log err
+    nconf.set b: true
+
+    nconf.save (err) ->
+        console.log err
Index: docker-alias.sh
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- docker-alias.sh	(revision )
+++ docker-alias.sh	(revision )
@@ -0,0 +1,19 @@
+#!/usr/bin/env bash
+if [ "$1" != "" ]; then
+    eval "$(docker-machine env $1)"
+    alias dclean="docker-machine ssh $1 'sudo rm -rf /var/cache/rplan'"
+fi
+if [ "${DOCKER_HOST}" != "" ]; then
+    echo "${DOCKER_HOST}"
+fi
+alias dnpm='docker-compose run --rm app'
+alias dinstall='dnpm install && dnpm run prepublish'
+alias dup='docker-compose up'
+alias drealclean='docker-compose rm -v'
+
+alias dtest="docker-compose -f docker-compose-tests.yml"
+alias dunit="dtest up unit"
+alias dclient="dtest up client_chrome"
+alias drest="dtest up rest"
+
+alias dselenium="docker-compose -f docker-compose-selenium.yml up"
\ No newline at end of file
Index: Dockerfile.dev
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- Dockerfile.dev	(revision )
+++ Dockerfile.dev	(revision )
@@ -0,0 +1,12 @@
+FROM node:4.1.2
+
+WORKDIR /opt/actano/rplan
+
+# This one as long as the build-server remains from lake
+RUN apt-get update && apt-get install -y netcat-openbsd
+
+ENV npm_config_cache /var/cache/npm-cache
+ENV NO_WEBPACK true
+
+ENTRYPOINT ["npm"]
+CMD ["install"]
\ No newline at end of file
Index: docker-compose-selenium.yml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- docker-compose-selenium.yml	(revision )
+++ docker-compose-selenium.yml	(revision )
@@ -0,0 +1,17 @@
+selenium_hub:
+  image: selenium/hub:2.47.1
+  container_name: selenium_hub
+  environment:
+    GRID_TIMEOUT: 0
+
+chrome:
+  image: selenium/node-chrome-debug:2.47.1
+  environment:
+    SCREEN_WIDTH: 1920
+    SCREEN_HEIGHT: 1080
+  ports:
+    - "5900:5900"
+  volumes:
+    - /dev/shm:/dev/shm
+  links:
+    - selenium_hub:hub
Index: docker-compose.yml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- docker-compose.yml	(revision a569e8195fb4339b13d238b9a7366803227d382d)
+++ docker-compose.yml	(revision )
@@ -1,62 +1,72 @@
 # compose file for local dev environment
-rplan:
-    build: .
+# SAD: hard-coded docker-host directories
+couchbase:
+    image: couchbase:community-3.0.1
+    expose:
+        - "8091"
+
+app:
     extends:
         file: common.yml
-        service: rplan
-    volumes:
-        - ./etc:/opt/actano/rplan/etc
-        - ./lib:/opt/actano/rplan/lib
-        - ./tools:/opt/actano/rplan/tools
+        service: nodejs
+
+    environment:
+        couchbase__host: couchbase
+        app__port: 8081
     links:
         - couchbase
-        - selenium_hub
-    environment:
-        - couchbase__host=couchbase
-        - RPLANX_TEST_DOMAIN=rplan:8081
-        - RPLANX_TEST_SERVER=selenium_hub
-        - DOCKER=1
-        - TERM=xterm
-        - NPM_CONFIG_LOGLEVEL=warn
-
-couchbase:
-    image: couchbase:community-3.0.1
-    container_name: couchbase
+    command: run start_docker
     ports:
-        - "8091:8091"
-    volumes_from:
-        - dbdata
+        - "8081:8081"
 
-selenium_hub:
-    image: selenium/hub:2.47.1
-    container_name: selenium_hub
-    environment:
-        - GRID_TIMEOUT=0
+webpack:
+    extends:
+        file: common.yml
+        service: nodejs
 
-selenium_chrome_node:
-    image: docker.actano.de/selenium/node-chrome-debug:2.47.1
-    container_name: selenium_chrome
-    links:
-        - selenium_hub:hub
-        - rplan
-    environment:
-        - SCREEN_WIDTH=1920
-        - SCREEN_HEIGHT=1080
-    ports:
-        - "5900:5900"
-    volumes:
-        - /dev/shm:/dev/shm
+    command: run client-build:watch
 
-selenium_firefox_node:
-    image: docker.actano.de/selenium/node-firefox-debug:2.47.1
-    container_name: selenium_firefox
-    links:
-        - selenium_hub:hub
-        - rplan
-    environment:
-        - SCREEN_WIDTH=1920
-        - SCREEN_HEIGHT=1080
-    ports:
-        - "5901:5900"
-    volumes:
-        - /dev/shm:/dev/shm
+#client_test:
+#    extends:
+#        file: common.yml
+#        service: nodejs
+#    environment:
+#        DOCKER: 1
+#        RPLANX_TEST_SERVER: selenium_hub
+#    links:
+#        - selenium_hub
+#    command: run client-test
+#
+#selenium_hub:
+#    image: selenium/hub:2.47.1
+#    container_name: selenium_hub
+#    environment:
+#        - GRID_TIMEOUT=0
+#
+#chrome:
+#    image: selenium/node-chrome-debug:2.47.1
+#    container_name: chrome
+#    links:
+#        - selenium_hub:hub
+#        - client_test:rplan
+#    environment:
+#        - SCREEN_WIDTH=1920
+#        - SCREEN_HEIGHT=1080
+#    ports:
+#        - "5900:5900"
+#    volumes:
+#        - /dev/shm:/dev/shm
+#
+#firefox:
+#    image: selenium/node-firefox-debug:2.47.1
+#    container_name: firefox
+#    links:
+#        - selenium_hub:hub
+#        - client_test:rplan
+#    environment:
+#        - SCREEN_WIDTH=1920
+#        - SCREEN_HEIGHT=1080
+#    ports:
+#        - "5901:5900"
+#    volumes:
+#        - /dev/shm:/dev/shm
